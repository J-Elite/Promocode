<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>เติมคะแนน J POINT (TEST)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');

  * {
    box-sizing: border-box;
  }

  body, html {
    margin: 0; padding: 0;
    height: 100%;
    font-family: 'Kanit', sans-serif;
    background-color: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container {
    background: #111;
    border: 3px solid #FFD700;
    border-radius: 16px;
    padding: 28px 24px 32px 24px;
    width: 90vw;
    max-width: 400px;
    box-shadow: 0 6px 24px rgba(255, 215, 0, 0.5);
    text-align: center;
    position: relative;
  }

  h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #FFD700;
    margin-bottom: 28px;
    user-select: none;
  }

  input[type="text"] {
    width: 100%;
    padding: 14px 18px;
    font-size: 1.2rem;
    border: 2.5px solid #FFD700;
    border-radius: 10px;
    background-color: #000;
    color: #fff;
    text-align: center;
    transition: border-color 0.3s;
  }

  input[type="text"]::placeholder {
    color: #aaa;
  }

  input[type="text"]:focus {
    outline: none;
    border-color: #FFC700;
    box-shadow: 0 0 8px #FFD700aa;
  }

  .button-group {
    margin-top: 24px;
    display: flex;
    gap: 8px; /* ช่องว่างปุ่มลดเหลือ 8px */
    justify-content: space-between;
  }

  #step-form .button-group button {
    flex: 1;
  }

  #step-confirm .button-group button {
    flex: 1;
  }

  button {
    padding: 14px 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s;
    user-select: none;
  }

  button:disabled {
    cursor: not-allowed;
  }

  #submitBtn {
    background-color: #E30613;
  }

  #submitBtn:disabled {
    background-color: #8B0000; /* สีแดงหม่นสำหรับ disabled */
  }

  #cancelBtn {
    background-color: #666;
  }

  #cancelBtn:hover,
  #cancelBtn:focus {
    background-color: #555;
    outline: none;
  }

  #confirmBtn {
    background-color: #E30613;
  }

  #confirmBtn:hover,
  #confirmBtn:focus {
    background-color: #B3040F;
    outline: none;
  }

  .message {
    margin-top: 18px;
    font-size: 1.1rem;
    color: #FFD700;
    min-height: 1.4em;
  }

  .hidden {
    display: none !important;
  }

  .summary {
    font-size: 1.1rem;
    color: #fff;
    margin-top: 14px;
    line-height: 1.6;
    user-select: none;
  }

  .summary-box {
    background-color: rgba(40, 40, 40, 0.9);
    border-radius: 12px;
    padding: 16px 20px;
    margin: 18px 0 24px 0;
    text-align: left;
    font-size: 0.9rem;
    color: #FFD700;
  }

  .summary-box div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .summary-box div span.value {
    color: #fff;
  }

  .success-icon {
    font-size: 6rem;
    color: #FFD700;
    margin-bottom: 18px;
    user-select: none;
    width: 96px;
    height: 96px;
    line-height: 96px;
    margin-left: auto;
    margin-right: auto;
    border: 3px solid #FFD700;
    border-radius: 50%;
    text-align: center;
  }

  .error-icon {
    font-size: 4rem;
    color: #E30613;
    margin-bottom: 18px;
    user-select: none;
  }

  /* Spinner */
  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top: 4px solid #FFD700;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    position: absolute;
    top: 20px;
    right: 20px;
    display: none;
    z-index: 100;
  }

  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }

  /* ปุ่มหน้าสรุป */
  #step-summary #backBtn {
    width: auto;
    min-width: 160px;
    max-width: 100%;
    white-space: nowrap;
    margin: 24px auto 0 auto;
    display: block;
    padding: 14px 20px;
  }

  @media (max-width: 350px) {
    h1 {
      font-size: 1.5rem;
    }
    input[type="text"], button {
      font-size: 1rem;
      padding: 12px 14px;
    }
    .success-icon, .error-icon {
      font-size: 4rem;
      width: 64px;
      height: 64px;
      line-height: 64px;
      margin-bottom: 14px;
    }
  }
</style>
</head>
<body>
  <div class="container" role="main" aria-label="ฟอร์มเติมคะแนน J POINT">
    <h1 id="form-title">กรอกรหัสรับคะแนน J POINT</h1>

    <!-- หน้าแรก กรอกโค้ด -->
    <div id="step-form">
      <input type="text" id="codeInput" placeholder="กรอกรหัสรับคะแนน" aria-label="กรอกโค้ดโปรโมชั่น" autocomplete="off" />
      <div class="button-group">
        <button id="cancelBtn" type="button">ยกเลิก</button>
        <button id="submitBtn" type="button" aria-live="polite" disabled>ยืนยัน</button>
      </div>
      <div class="message" id="message" aria-live="polite"></div>
      <div class="spinner" id="loadingSpinner" aria-hidden="true"></div>
    </div>

    <!-- หน้ายืนยันก่อนเติมคะแนน -->
    <div id="step-confirm" class="hidden" role="alert" aria-live="assertive">
      <h1 id="confirm-title" style="color:#FFD700; text-align:left; font-weight:700; margin-bottom: 16px;">ยืนยันการรับคะแนน</h1>
      <div class="summary-box" style="font-size: 1rem;">
        <div><span>รหัสเติมคะแนน</span><span class="value" id="confirm-code">-</span></div>
        <div><span>คะแนนที่จะได้รับ</span><span class="value" id="confirm-points">-</span></div>
      </div>
      <div class="button-group">
        <button id="confirmCancelBtn" type="button">ยกเลิก</button>
        <button id="confirmBtn" type="button">ยืนยัน</button>
      </div>
      <div class="message" id="confirm-message" style="color:#FFD700; margin-top:10px; min-height:1.4em;"></div>
      <div class="spinner" id="confirmSpinner" aria-hidden="true" style="position:absolute; top:20px; right:20px; display:none;"></div>
    </div>

    <!-- หน้าสรุปหลังเติมคะแนน -->
    <div id="step-summary" class="hidden" role="alert" aria-live="assertive">
      <div style="font-size:1.3rem; font-weight:700; color:#FFD700; margin-bottom: 16px; text-align:center;">
        ระบบทำรายการเรียบร้อยแล้ว
      </div>
      <div class="success-icon" aria-hidden="true">✔</div>
      <div class="summary-box" style="font-size: 0.9rem; color:#FFD700;">
        <div><span>รหัสเติมคะแนน</span><span class="value" id="summary-code">-</span></div>
        <div><span>คะแนนที่ได้รับ</span><span class="value" id="summary-points">-</span></div>
        <div><span>วันที่ / เวลา</span><span class="value" id="summary-datetime" style="color:#fff;"></span></div>
      </div>
      <button id="backBtn" type="button">กลับสู่หน้าหลัก</button>
    </div>

    <!-- หน้าข้อผิดพลาด -->
    <div id="step-error" class="hidden" role="alert" aria-live="assertive">
      <div class="error-icon" aria-hidden="true">✖</div>
      <div class="summary" id="error-text"></div>
      <button id="retryBtn" type="button">ลองใหม่อีกครั้ง</button>
    </div>
  </div>

<script>
  const AUTH_CONFIG = {
    partnerCode: "JP_DEV",
    clientId: "JP_DEV",
    clientSecret: "423e410c51e0a02c84d1c6046f97c9df1debde99a1aa1c216a39aa3e3756bd02a00401d99eaa264db266fad39f84680f1389af8f2803569ef788a031a2d82f05"
  };

  const ENDPOINTS = {
    auth: "https://sit-api.jpointcrm.com/api/v1/partner/auth",
    topup: "https://sit-api.jpointcrm.com/api/v1/partner/credit/topup"
  };

  let authToken = "";
  let accountNumber = "";
  let currentCodeData = null;
  let currentUserCode = "";

  // ตัวอย่างฐานข้อมูลโค้ดโปรโมชั่น
  const codeDB = {
    "001": { brandName: "J POINT", points: 200 },
    "ABC": { brandName: "J POINT", points: 500 }
  };

  // เก็บ auth token และ timestamp ใน sessionStorage
  function saveAuthToken(token) {
    sessionStorage.setItem("authToken", token);
    sessionStorage.setItem("authTokenTimestamp", Date.now());
  }

  function loadAuthToken() {
    const token = sessionStorage.getItem("authToken");
    const timestamp = sessionStorage.getItem("authTokenTimestamp");
    if (!token || !timestamp) return null;

    // สมมติ token มีอายุ 1 ชั่วโมง (3600000 ms)
    if (Date.now() - timestamp > 3600000) {
      return null; // token หมดอายุ
    }
    return token;
  }

  async function fetchAuthToken() {
    try {
      const existingToken = loadAuthToken();
      if (existingToken) {
        authToken = existingToken;
        return;
      }

      const res = await fetch(ENDPOINTS.auth, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(AUTH_CONFIG)
      });
      const data = await res.json();
      authToken = data?.data?.authToken || "";
      if (!authToken) throw new Error("No auth token");
      saveAuthToken(authToken);
    } catch (err) {
      showError("ไม่สามารถยืนยันตัวตนได้");
      throw err;
    }
  }

  function validateCode(code) {
    return codeDB[code] || null;
  }

  function generateRequestNumber() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let result = "JPTOPUP";
    while (result.length < 25) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  async function topupPoints(codeData, userCode) {
    const today = new Date();
    const businessDate = today.toISOString().slice(0,10);
    const branchName = "-";

    const payload = {
      businessDate: businessDate,
      brandName: codeData.brandName,
      branchName: branchName,
      creditCode: "POINT",
      creditTopupAmount: codeData.points,
      memberCode: accountNumber,
      orderNumber: userCode,
      requestNumber: generateRequestNumber(),
      requestType: "Submit"
    };

    const res = await fetch(ENDPOINTS.topup, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + authToken
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      throw new Error("Topup failed");
    }
    return await res.json();
  }

  function showLoading(show, forConfirm = false) {
    const spinner = forConfirm ? document.getElementById("confirmSpinner") : document.getElementById("loadingSpinner");
    spinner.style.display = show ? "block" : "none";
  }

  function showStep(stepId) {
    ["step-form", "step-confirm", "step-summary", "step-error"].forEach(id => {
      document.getElementById(id).classList.add("hidden");
    });
    document.getElementById(stepId).classList.remove("hidden");
  }

  document.getElementById("codeInput").addEventListener("input", () => {
    const val = document.getElementById("codeInput").value.trim();
    document.getElementById("submitBtn").disabled = val.length === 0;
    document.getElementById("message").textContent = "";
  });

  document.getElementById("cancelBtn").addEventListener("click", () => {
    window.location.href = "about:blank"; // หรือจะเปลี่ยนเป็น URL หน้าอื่นตามต้องการ
  });

  document.getElementById("submitBtn").addEventListener("click", () => {
    const codeInput = document.getElementById("codeInput").value.trim();
    const codeData = validateCode(codeInput);
    if (!codeData) {
      showError("โค้ดไม่ถูกต้อง หรือหมดอายุ");
      return;
    }
    currentCodeData = codeData;
    currentUserCode = codeInput;

    // แสดงหน้าสรุปก่อนยืนยัน
    document.getElementById("confirm-code").textContent = currentUserCode;
    document.getElementById("confirm-points").textContent = "+" + currentCodeData.points + " คะแนน";
    document.getElementById("confirm-message").textContent = "";
    showStep("step-confirm");
  });

  document.getElementById("confirmCancelBtn").addEventListener("click", () => {
    showStep("step-form");
  });

  document.getElementById("confirmBtn").addEventListener("click", async () => {
    showLoading(true, true);
    document.getElementById("confirm-message").textContent = "กำลังเติมคะแนน...";
    try {
      await fetchAuthToken();
      await topupPoints(currentCodeData, currentUserCode);
      showLoading(false, true);
      showSummary(currentCodeData.points, currentUserCode);
    } catch (err) {
      showLoading(false, true);
      if (!authToken) {
        showError("ไม่สามารถยืนยันตัวตนได้");
      } else {
        showError("ไม่สามารถเติมคะแนนได้");
      }
    }
  });

  function showSummary(points, code) {
    showStep("step-summary");
    const now = new Date();
    document.getElementById("summary-code").textContent = code;
    document.getElementById("summary-points").textContent = "+" + points + " คะแนน";
    document.getElementById("summary-datetime").textContent =
      now.toLocaleDateString("th-TH",{day:'numeric',month:'long',year:'numeric'}) + " " +
      now.toLocaleTimeString("th-TH",{hour:'2-digit',minute:'2-digit'});
  }

  function showError(msg) {
    showStep("step-error");
    document.getElementById("error-text").innerHTML = msg;
  }

  document.getElementById("backBtn").addEventListener("click", () => {
    window.location.reload();
  });

  document.getElementById("retryBtn").addEventListener("click", () => {
    window.location.reload();
  });

  function getUserID() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get("userID");
  }

  window.addEventListener("DOMContentLoaded", async () => {
    accountNumber = getUserID();
    if (!accountNumber) {
      showError("ไม่พบ userID ใน URL");
      return;
    }
    try {
      await fetchAuthToken();
    } catch {
      // Error แสดงไปแล้วใน fetchAuthToken()
    }
  });
</script>
</body>
</html>
